#move next 3 lines to /etc/nginx/nginx.conf if you want to use fastcgi_cache across many sites 
fastcgi_cache_path /var/run/nginx-cache levels=1:2 keys_zone=WORDPRESS:500m inactive=60m;
fastcgi_cache_key "$scheme$request_method$host$request_uri";
fastcgi_cache_use_stale error timeout invalid_header http_500;

server {
    listen 80;
    listen [::]:80;
    server_name gamingmuse.com www.gamingmuse.com;
    return 301 https://www.gamingmuse.com$request_uri;
    expires max;
}

server {

    listen 443;
    listen [::]:443;
    
    server_name gamingmuse.com;
    
    ssl on;
    include /etc/nginx/custom/confs/ssl-gamingmuse.com.conf;
    include /etc/nginx/custom/ssl-params.conf;
    
    return 301 https://www.gamingmuse.com$request_uri;
    expires max;
    
    }
    
    server {

    listen 443 http2;
    listen [::]:443 http2;
    
    server_name www.gamingmuse.com;
    
    ssl on;
    include /etc/nginx/custom/confs/ssl-gamingmuse.com.conf;
    include /etc/nginx/custom/ssl-params.conf;
    include /etc/nginx/custom/confs/restrictions.conf;
    
    root /etc/nginx/html/gamingmuse.com/www/public;
    index index.php index.html index.htm;
    
    #W3 TOTAL CACHE CHECK 
set $cache_uri $request_uri;

# POST requests and urls with a query string should always go to PHP
if ($request_method = POST) {
        set $cache_uri 'null cache';
}   
if ($query_string != "") {
        set $cache_uri 'null cache';
}   

# Don't cache uris containing the following segments
if ($request_uri ~* "(/wp-admin/|/xmlrpc.php|/wp-(app|cron|login|register|mail).php|wp-.*.php|/feed/|index.php|wp-comments-popup.php|wp-links-opml.php|wp-locations.php|sitemap(_index)?.xml|[a-z0-9_-]+-sitemap([0-9]+)?.xml)") {
        set $cache_uri 'null cache';
}   

# Don't use the cache for logged in users or recent commenters
if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_logged_in") {
        set $cache_uri 'null cache';
}
    #fastcgi_cache start
set $no_cache 0;

# POST requests and urls with a query string should always go to PHP
if ($request_method = POST) {
        set $no_cache 1;
}   
if ($query_string != "") {
        set $no_cache 1;
}   

# Don't cache uris containing the following segments
if ($request_uri ~* "(/wp-admin/|/xmlrpc.php|/wp-(app|cron|login|register|mail).php|wp-.*.php|/feed/|index.php|wp-comments-popup.php|wp-links-opml.php|wp-locations.php|sitemap(_index)?.xml|[a-z0-9_-]+-sitemap([0-9]+)?.xml)") {
        set $no_cache 1;
}   

# Don't use the cache for logged in users or recent commenters
if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
        set $no_cache 1;
} 
    location ~ /*.conf {
                deny all;
        }
        
        location ~ /wp-config.php {
                deny all;
        }
    
    location ~ /.well-known {
                allow all;
        }
    
    location / {
    try_files /wp-content/w3tc/pgcache/$cache_uri/_index.html $uri $uri/ /index.php?$args;
    }
    location ~ \.php$ {
                include fastcgi.conf;
                include fastcgi_params;
                fastcgi_pass unix:/run/php/php7.1-fpm.sock;
                fastcgi_param SCRIPT_FILENAME /etc/nginx/html/gamingmuse.com/www/public$fastcgi_script_name;
                
                fastcgi_cache_bypass $no_cache;
         fastcgi_no_cache $no_cache;

         fastcgi_cache WORDPRESS;
         fastcgi_cache_valid 200 60m;
        }
        
        location ~ /purge(/.*) {
        # Uncomment the following two lines to allow purge only from the webserver
        #allow 127.0.0.1;
	#deny all;

        fastcgi_cache_purge WORDPRESS "$scheme$request_method$host$1";
} 
    }
